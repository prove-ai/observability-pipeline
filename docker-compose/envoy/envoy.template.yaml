static_resources:
  listeners:
    # OTLP gRPC receiver (port 4317)
    - name: otel_grpc_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 4317
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: otel_grpc
                codec_type: AUTO
                http2_protocol_options: {}
                http_filters:
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        function base64_decode(data)
                          local b = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
                          data = string.gsub(data, '[^'..b..'=]', '')
                          return (data:gsub('.', function(x)
                            if (x == '=') then return '' end
                            local r,f='',(b:find(x)-1)
                            for i=6,1,-1 do r=r..(f%2^i-f%2^(i-1)>0 and '1' or '0') end
                            return r;
                          end):gsub('%d%d%d?%d?%d?%d?%d?%d?', function(x)
                            if (#x ~= 8) then return '' end
                            local c=0
                            for i=1,8 do c=c+(x:sub(i,i)=='1' and 2^(8-i) or 0) end
                            return string.char(c)
                          end))
                        end
                        function envoy_on_request(request_handle)
                          local auth_method = "__ENVOY_AUTH_METHOD__"
                          local authenticated = false
                          
                          -- API Key Authentication
                          if auth_method == "api-key" then
                            local api_key = request_handle:headers():get("X-API-Key")
                            local valid_keys = {
                              ${ENVOY_API_KEYS}
                            }
                            
                            if api_key then
                              for _, key in ipairs(valid_keys) do
                                if api_key == key then
                                  authenticated = true
                                  break
                                end
                              end
                            end
                            
                            if authenticated and auth_method == "api-key" then
                              return
                            end
                          end
                          
                          -- Basic Authentication
                          if auth_method == "basic-auth" then
                            local auth_header = request_handle:headers():get("Authorization")
                            local valid_credentials = {
                              ${ENVOY_BASIC_AUTH_CREDENTIALS}
                            }
                            
                            if auth_header then
                              local auth_type, encoded = string.match(auth_header, "^(%S+)%s+(.+)$")
                              if auth_type == "Basic" and encoded then
                                local decoded = base64_decode(encoded)
                                for _, cred in ipairs(valid_credentials) do
                                  if decoded == cred then
                                    authenticated = true
                                    break
                                  end
                                end
                              end
                            end
                          end
                          
                          if not authenticated then
                            if auth_method == "api-key" then
                              request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Missing or Invalid API Key")
                            elseif auth_method == "basic-auth" then
                              request_handle:respond({[":status"] = "401", ["WWW-Authenticate"] = "Basic realm=\"Observability Pipeline\""}, "Unauthorized")
                            else
                              request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Unauthorized")
                            end
                            return
                          end
                        end
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: otel_grpc_route
                  virtual_hosts:
                    - name: otel_grpc_service
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: otel_collector_grpc
                upgrade_configs:
                  - upgrade_type: websocket
                  - upgrade_type: CONNECT

    # OTLP HTTP receiver (port 4318)
    - name: otel_http_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 4318
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: otel_http
                http_filters:
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        function base64_decode(data)
                          local b = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
                          data = string.gsub(data, '[^'..b..'=]', '')
                          return (data:gsub('.', function(x)
                            if (x == '=') then return '' end
                            local r,f='',(b:find(x)-1)
                            for i=6,1,-1 do r=r..(f%2^i-f%2^(i-1)>0 and '1' or '0') end
                            return r;
                          end):gsub('%d%d%d?%d?%d?%d?%d?%d?', function(x)
                            if (#x ~= 8) then return '' end
                            local c=0
                            for i=1,8 do c=c+(x:sub(i,i)=='1' and 2^(8-i) or 0) end
                            return string.char(c)
                          end))
                        end
                        function envoy_on_request(request_handle)
                          local auth_method = "__ENVOY_AUTH_METHOD__"
                          local authenticated = false
                          
                          -- API Key Authentication
                          if auth_method == "api-key" then
                            local api_key = request_handle:headers():get("X-API-Key")
                            local valid_keys = {
                              ${ENVOY_API_KEYS}
                            }
                            
                            if api_key then
                              for _, key in ipairs(valid_keys) do
                                if api_key == key then
                                  authenticated = true
                                  break
                                end
                              end
                            end
                            
                            if authenticated and auth_method == "api-key" then
                              return
                            end
                          end
                          
                          -- Basic Authentication
                          if auth_method == "basic-auth" then
                            local auth_header = request_handle:headers():get("Authorization")
                            local valid_credentials = {
                              ${ENVOY_BASIC_AUTH_CREDENTIALS}
                            }
                            
                            if auth_header then
                              local auth_type, encoded = string.match(auth_header, "^(%S+)%s+(.+)$")
                              if auth_type == "Basic" and encoded then
                                local decoded = base64_decode(encoded)
                                for _, cred in ipairs(valid_credentials) do
                                  if decoded == cred then
                                    authenticated = true
                                    break
                                  end
                                end
                              end
                            end
                          end
                          
                          if not authenticated then
                            if auth_method == "api-key" then
                              request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Missing or Invalid API Key")
                            elseif auth_method == "basic-auth" then
                              request_handle:respond({[":status"] = "401", ["WWW-Authenticate"] = "Basic realm=\"Observability Pipeline\""}, "Unauthorized")
                            else
                              request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Unauthorized")
                            end
                            return
                          end
                        end
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: otel_http_route
                  virtual_hosts:
                    - name: otel_http_service
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: otel_collector_http

    # Prometheus (port 9090)
    - name: prometheus_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9090
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: prometheus
                http_filters:
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        function envoy_on_request(request_handle)
                          local auth_method = "__ENVOY_AUTH_METHOD__"
                          
                          -- If Basic Auth is enabled, skip authentication for Prometheus
                          if auth_method == "basic-auth" then
                            return
                          end
                          
                          -- Otherwise enforce API Key Authentication specifically for Prometheus
                          local api_key = request_handle:headers():get("X-API-Key")
                          local valid_keys = {
                            ${ENVOY_API_KEYS}
                          }
                          
                          if not api_key then
                            request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Missing API Key")
                            return
                          end
                          
                          local is_valid = false
                          for _, key in ipairs(valid_keys) do
                            if api_key == key then
                              is_valid = true
                              break
                            end
                          end
                          
                          if not is_valid then
                            request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Invalid API Key")
                            return
                          end
                        end
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: prometheus_route
                  virtual_hosts:
                    - name: prometheus_service
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: prometheus

    # VictoriaMetrics (port 8428)
    - name: victoriametrics_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8428
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: victoriametrics
                http_filters:
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      inline_code: |
                        function base64_decode(data)
                          local b = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
                          data = string.gsub(data, '[^'..b..'=]', '')
                          return (data:gsub('.', function(x)
                            if (x == '=') then return '' end
                            local r,f='',(b:find(x)-1)
                            for i=6,1,-1 do r=r..(f%2^i-f%2^(i-1)>0 and '1' or '0') end
                            return r;
                          end):gsub('%d%d%d?%d?%d?%d?%d?%d?', function(x)
                            if (#x ~= 8) then return '' end
                            local c=0
                            for i=1,8 do c=c+(x:sub(i,i)=='1' and 2^(8-i) or 0) end
                            return string.char(c)
                          end))
                        end
                        function envoy_on_request(request_handle)
                          local auth_method = "__ENVOY_AUTH_METHOD__"
                          local authenticated = false
                          
                          -- API Key Authentication
                          if auth_method == "api-key" then
                            local api_key = request_handle:headers():get("X-API-Key")
                            local valid_keys = {
                              ${ENVOY_API_KEYS}
                            }
                            
                            if api_key then
                              for _, key in ipairs(valid_keys) do
                                if api_key == key then
                                  authenticated = true
                                  break
                                end
                              end
                            end
                            
                            if authenticated and auth_method == "api-key" then
                              return
                            end
                          end
                          
                          -- Basic Authentication
                          if auth_method == "basic-auth" then
                            local auth_header = request_handle:headers():get("Authorization")
                            local valid_credentials = {
                              ${ENVOY_BASIC_AUTH_CREDENTIALS}
                            }
                            
                            if auth_header then
                              local auth_type, encoded = string.match(auth_header, "^(%S+)%s+(.+)$")
                              if auth_type == "Basic" and encoded then
                                local decoded = base64_decode(encoded)
                                for _, cred in ipairs(valid_credentials) do
                                  if decoded == cred then
                                    authenticated = true
                                    break
                                  end
                                end
                              end
                            end
                          end
                          
                          if not authenticated then
                            if auth_method == "api-key" then
                              request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Missing or Invalid API Key")
                            elseif auth_method == "basic-auth" then
                              request_handle:respond({[":status"] = "401", ["WWW-Authenticate"] = "Basic realm=\"Observability Pipeline\""}, "Unauthorized")
                            else
                              request_handle:respond({[":status"] = "401", ["Content-Type"] = "text/plain"}, "Unauthorized")
                            end
                            return
                          end
                        end
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                route_config:
                  name: victoriametrics_route
                  virtual_hosts:
                    - name: victoriametrics_service
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: victoriametrics

  clusters:
    # OTel Collector gRPC cluster
    - name: otel_collector_grpc
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      http2_protocol_options: {}
      load_assignment:
        cluster_name: otel_collector_grpc
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: otel-collector
                      port_value: 4317

    # OTel Collector HTTP cluster
    - name: otel_collector_http
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: otel_collector_http
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: otel-collector
                      port_value: 4318

    # Prometheus cluster
    - name: prometheus
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: prometheus
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: prometheus
                      port_value: 9090

    # VictoriaMetrics cluster
    - name: victoriametrics
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: victoriametrics
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: victoriametrics
                      port_value: 8428

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901
# Force rebuild Tue Dec  9 13:10:45 EST 2025
